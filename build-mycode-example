#!/bin/bash
#HPCI -n my_code
#HPCI -v 1.2.3
#HPCI -u http://www.example.com
#HPCI -x export SOMETHING=3
#HPCI -l ncarenv
#HPCI -l gnu                # modules can be loaded on same line or multiple lines 
#HPCI -p netcdf             # even if they are prerequisite modules, however, the order
#HPCI -p ncl                # of their dependency must be respected
#HPCI -p another_module
#HPCI -p yet many other modules here

# terminate this script immediately should anything go wrong
set -e

echo Value of SOMETHING=$SOMETHING
echo This script pretend to installing 
echo $HPCI_SW_NAME version $HPCI_SW_VERSION in ${HPCI_SW_DIR}.
echo And modules somewhere in $HPCI_MOD_DIR (or subdirs),
echo using prerequisite module $HPCI_MOD_PREREQ

./configure --prefix=$HPCI_SW_DIR
make
make install

# Create the module directory, if needed
# if this were compiler-independent module $HPCI_MOD_DIR_IDEP would have been used
mkdir -p $HPCI_MOD_DIR_CDEP/$HPCI_SW_NAME/

# Create the module with the following template
cat << EOF > $HPCI_MOD_DIR_CDEP/$HPCI_SW_NAME/${HPCI_SW_VERSION}.lua
require("posix")

whatis("$HPCI_SW_NAME v$HPCI_SW_VERSION")

help([[
This module loads my_code.
See http://my_code.example.com/ for details.
]])

local verpath = "$HPCI_SW_DIR"                    -- specific version path
local binpath = pathJoin(verpath, "bin")          -- internal python libs
-- similarly for includes or others

prepend_path("PATH", binpath)

prereq($HPCI_MOD_PREREQ)
EOF

